# Heroes Platform Makefile
# Provides convenient commands for project management

.PHONY: help install install-dev install-prod test clean setup venv deps run-server run-tests lint format check-all docs docs-serve docs-build

# Default target
help:
	@echo "ðŸŽ¯ Heroes Platform - Available Commands"
	@echo "======================================"
	@echo ""
	@echo "ðŸ“¦ Installation:"
	@echo "  install      - Install all dependencies (dev + production)"
	@echo "  install-dev  - Install development dependencies only"
	@echo "  install-prod - Install production dependencies only"
	@echo "  setup        - Complete setup (venv + deps + config)"
	@echo "  venv         - Create virtual environment"
	@echo "  deps         - Install dependencies from pyproject.toml"
	@echo ""
	@echo "ðŸ§ª Testing:"
	@echo "  test         - Run all tests"
	@echo "  test-mcp-logs - Run MCP logs monitoring tests"
	@echo "  test-unit    - Run unit tests only"
	@echo "  test-integration - Run integration tests only"
	@echo "  test-coverage - Run tests with coverage report"
	@echo ""
	@echo "ðŸ”§ Development:"
	@echo "  lint         - Run linting (ruff, mypy)"
	@echo "  format       - Format code (black, isort)"
	@echo "  check-all    - Run all checks (lint + format + test)"
	@echo ""
	@echo "ðŸš€ Running:"
	@echo "  run-server   - Start MCP server"
	@echo "  run-tests    - Run test suite"
	@echo ""
	@echo "ðŸ“š Documentation:"
	@echo "  docs         - Build documentation"
	@echo "  docs-serve   - Serve documentation locally"
	@echo "  docs-build   - Build and validate documentation"
	@echo ""
	@echo "ðŸ§¹ Maintenance:"
	@echo "  clean        - Clean build artifacts and cache"
	@echo "  clean-venv   - Remove virtual environment"
	@echo ""

# Installation targets
install: deps
	@echo "âœ… All dependencies installed"

install-dev: venv
	@echo "ðŸ“¦ Installing development dependencies..."
	python -m pip install -e ".[dev]"
	@echo "âœ… Development dependencies installed"

install-prod: venv
	@echo "ðŸ“¦ Installing production dependencies..."
	python -m pip install -e ".[production]"
	@echo "âœ… Production dependencies installed"

setup: venv deps setup-mcp
	@echo "ðŸ”§ Setting up project structure..."
	@mkdir -p logs output data config tests src
	@echo "ðŸ“„ Copying configuration files..."
	@if [ ! -f "pyproject.toml" ]; then echo "âŒ pyproject.toml not found in heroes_platform/"; exit 1; fi
	@if [ -f "../.env" ] && [ ! -f ".env" ]; then cp ../.env .; fi
	@echo "âœ… Setup complete"

setup-mcp:
	@echo "ðŸ”§ Setting up MCP configuration..."
	@python scripts/setup_mcp_config.py
	@echo "âœ… MCP configuration setup complete"

venv:
	@echo "ðŸ Creating virtual environment..."
	@python -m venv .venv
	@echo "âœ… Virtual environment created"

deps: venv
	@echo "ðŸ“¦ Installing dependencies from pyproject.toml..."
	@python setup.py
	@echo "âœ… Dependencies installed"

# Testing targets
test: install-dev
	@echo "ðŸ§ª Running all tests..."
	@python -m pytest tests/ -v

test-unit: install-dev
	@echo "ðŸ§ª Running unit tests..."
	@python -m pytest tests/ -m "unit" -v

test-integration: install-dev
	@echo "ðŸ§ª Running integration tests..."
	@python -m pytest tests/ -m "integration" -v

test-coverage: install-dev
	@echo "ðŸ§ª Running tests with coverage..."
	@python -m pytest tests/ --cov=. --cov-report=html --cov-report=term --cov-fail-under=80

test-mcp-logs: install-dev
	@echo "ðŸ” Running MCP logs monitoring tests..."
	@python3 scripts/test_mcp_logs_monitoring.py

test-validate-outcome: install-dev
	@echo "ðŸ§ª Testing validate_actual_outcome..."
	@python -c "from heroes_mcp.src.heroes_mcp_server import validate_actual_outcome; result = validate_actual_outcome('https://github.com', take_screenshot=False); print('âœ… validate_actual_outcome test passed')"

test-ci: install-dev
	@echo "ðŸ§ª Running CI test suite..."
	@python -m pytest tests/ --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=80
	@python -c "from heroes_mcp.src.heroes_mcp_server import validate_actual_outcome; result = validate_actual_outcome('https://github.com', take_screenshot=False); print('âœ… validate_actual_outcome test passed')"

# Development targets
lint: install-dev
	@echo "ðŸ” Running linting..."
	@python -m ruff check .
	@python -m mypy . --ignore-missing-imports

format: install-dev
	@echo "ðŸŽ¨ Formatting code..."
	@python -m black .
	@python -m isort .

check-all: format lint test test-validate-outcome
	@echo "âœ… All checks passed"

# Documentation targets
docs: install-dev
	@echo "ðŸ“š Building documentation..."
	@python docs_cli.py build

docs-serve: install-dev
	@echo "ðŸ“š Serving documentation locally..."
	@python docs_cli.py serve

docs-status: install-dev
	@echo "ðŸ“Š Documentation status..."
	@python docs_cli.py status

docs-clean: install-dev
	@echo "ðŸ§¹ Cleaning documentation..."
	@python docs_cli.py clean

docs-validate: docs
	@echo "ðŸ” Running documentation validation..."
	@python docs_cli.py validate

# Running targets
run-server: install-dev
	@echo "ðŸš€ Starting MCP server..."
	@cd mcp_server && python run_mcp_server.py

run-tests: install-dev
	@echo "ðŸ§ª Running test suite..."
	@python run_tests.py

# Maintenance targets
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name "*.pyd" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".coverage" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Clean complete"

clean-venv:
	@echo "ðŸ§¹ Removing virtual environment..."
	@rm -rf .venv
	@echo "âœ… Virtual environment removed"

# Platform-specific shortcuts
install-unix: install.sh
	@chmod +x install.sh
	@./install.sh

install-windows: install.bat
	@install.bat

# Quick setup for new projects
quick-setup:
	@echo "âš¡ Quick setup for new project..."
	@make setup
	@make test
	@echo "âœ… Quick setup complete"


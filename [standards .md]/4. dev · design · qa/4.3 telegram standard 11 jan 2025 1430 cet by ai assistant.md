# 📱 Telegram Standard

<!-- 🔒 PROTECTED SECTION: BEGIN -->type: standard

standard_id: 4.3
logical_id: standard:telegram_standard
updated: 11 Jan 2025, 14:30 CET by AI Assistant
previous version: N/A (initial version)
based on: [Registry Standard](abstract://standard:registry_standard), версия 6.6, 10 September 2025, 19:30 CET by AI Assistant
integrated: [Task Master Standard](abstract://standard:task_master_standard), версия 1.4, 15 May 2025, 18:20 CET by AI Assistant, [MCP Workflow Standard](abstract://standard:mcp_workflow_standard)
version: 1.0
status: Active
tags: standard, telegram, mcp, integration, workflow

<!-- 🔒 PROTECTED SECTION: END -->

---

## 🛡️ Лицензия и условия использования

**Все права защищены.** Данный документ является интеллектуальной собственностью Ильи Красинского и не может быть скопирован, использован или адаптирован в любых целях без предварительного письменного согласия автора. Авторские права защищены законодательством США.

**Magic Rick Inc.**, зарегистрированная в штате Делавэр (США), действует от имени автора в целях защиты его интеллектуальной собственности и будет преследовать любые нарушения в соответствии с законодательством США.

---

## 🎯 Цель документа

Создать стандарт для интеграции Telegram с Cursor IDE через MCP (Model Context Protocol), обеспечивающий эффективную отправку и обновление checklist'ов, задач и сообщений в Telegram. Стандарт основан на принципах Registry Standard и Task Master Standard для обеспечения целостности и качества интеграции.

---

## 🔄 MCP Workflow Integration Requirements

### Atomic Operation Principle
Все операции с Telegram через MCP должны быть разбиты на атомарные шаги с обязательными точками рефлексии:

1. **Каждый шаг = отдельная MCP команда с рефлексией**
2. **Никаких монолитных операций** - декомпозиция на проверяемые этапы
3. **Точка рефлексии после каждого шага** - валидация перед продолжением
4. **Возможность отката** - каждый шаг должен быть обратимым
5. **Отслеживание состояния** - поддержание состояния workflow между шагами

### Mandatory Reflection Points
- Валидация входных данных: "Работаю ли я с валидными данными?"
- Валидация процесса: "Следую ли я правильной процедуре?"
- Валидация вывода: "Соответствует ли результат стандартам качества?"
- Соответствие стандартам: "Соответствует ли это всем применимым стандартам?"

### Telegram Workflow Example
Процесс отправки и обновления checklist демонстрирует правильный атомарный workflow:
1. validate_telegram_credentials → [reflection]
2. find_or_create_chat → [reflection]
3. send_initial_checklist → [reflection]
4. track_message_id → [reflection]
5. update_checklist_item → [reflection]
6. validate_telegram_response → [reflection]
7. log_telegram_activity → [reflection]

---

## 🏗️ Telegram MCP Architecture

### Unified Telegram MCP Architecture
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Cursor IDE    │────│  Telegram MCP    │────│   Telegram      │
│                 │    │  Server          │    │   API           │
│  MCP Commands   │    │  (Python)        │    │  (Telethon)     │
│  73 Tools       │    │  FastMCP         │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
        │                        │                        │
        ▼                        ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Profile        │    │  Keychain        │    │  Session        │
│  Management     │    │  Integration     │    │  Management     │
│  (lisa/ik)      │    │  (macOS)         │    │  (String/File)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Core Components
- **Telegram MCP Server** (Python) - Основной MCP сервер с 73 инструментами
- **Profile Manager** (Python) - Управление профилями (lisa, ikrasinsky)
- **Keychain Integration** (Python) - Безопасное хранение ключей в macOS Keychain
- **Session Management** (Python) - Управление Telegram сессиями
- **Error Handling** (Python) - Комплексная система обработки ошибок

---

## 📋 JTBD-сценарии использования Telegram Standard

### Сценарий 1: Отправка checklist в Telegram

**Когда** пользователь хочет отправить checklist в Telegram из Cursor,
**Роль** AI-ассистент или разработчик,
**Хочет** быстро отправить структурированный список задач в Telegram,
**Закрывает потребность** в синхронизации задач между Cursor и Telegram,
**Мы показываем** пошаговый процесс отправки через MCP команды,
**Понимает** как использовать telegram-mcp сервер для отправки сообщений,
**Отправляет** checklist в выбранный чат с правильным форматированием.

### Сценарий 2: Обновление checklist в Telegram

**Когда** пользователь хочет обновить существующий checklist в Telegram,
**Роль** AI-ассистент или разработчик,
**Хочет** изменить статус задач или добавить новые пункты,
**Закрывает потребность** в актуальности информации в Telegram,
**Мы показываем** процесс редактирования сообщений через MCP,
**Понимает** как найти и обновить конкретное сообщение,
**Обновляет** checklist с сохранением форматирования и структуры.

### Сценарий 3: Создание группового checklist

**Когда** пользователь хочет создать групповой checklist для команды,
**Роль** AI-ассистент или менеджер проекта,
**Хочет** создать группу и отправить checklist всем участникам,
**Закрывает потребность** в командной работе и прозрачности задач,
**Мы показываем** процесс создания группы и отправки сообщений,
**Понимает** как управлять группами и участниками,
**Создает** группу и отправляет checklist с правильными правами доступа.

---

## 🔧 Telegram MCP Commands Classification

### ✅ **MCP Commands MUST be:**
- **User Actions** - что пользователь хочет сделать
- **Main Workflows** - основные функции системы
- **External Integrations** - вызовы API и интеграции с системами
- **Public Interfaces** - экспортируемая функциональность

### ❌ **MCP Commands MUST NOT be:**
- **Helper Functions** - валидация, форматирование, утилиты
- **Internal Logic** - обработка данных, вычисления
- **Private Methods** - внутренние методы классов
- **Utility Operations** - файловые операции, парсинг

### 📋 **Classification Criteria:**

| Criterion | MCP Command | Internal Function |
|-----------|-------------|-------------------|
| **User Action** | ✅ Yes | ❌ No |
| **Public Interface** | ✅ Yes | ❌ No |
| **External Integration** | ✅ Yes | ❌ No |
| **Validation/Formatting** | ❌ No | ✅ Yes |
| **Internal Calculations** | ❌ No | ✅ Yes |
| **Utility Operations** | ❌ No | ✅ Yes |

### 🔧 **Examples of Correct Classification:**

```python
# ✅ MCP COMMAND - user action
@mcp.tool()
async def send_message(chat_id: int, message: str) -> str:
    """Send a message to a specific chat"""
    entity = await client.get_entity(chat_id)
    await client.send_message(entity, message)
    return "Message sent successfully."

# ✅ MCP COMMAND - user action
@mcp.tool()
async def edit_message(chat_id: int, message_id: int, new_text: str) -> str:
    """Edit a message you sent"""
    entity = await client.get_entity(chat_id)
    await client.edit_message(entity, message_id, new_text)
    return f"Message {message_id} edited."

# ❌ INTERNAL FUNCTION - helper logic
async def _validate_chat_id(chat_id: int) -> bool:
    """Validate chat ID"""
    return isinstance(chat_id, int) and chat_id != 0

# ❌ INTERNAL FUNCTION - utility operation
async def _format_checklist_markdown(tasks: list) -> str:
    """Format checklist as markdown"""
    return "\n".join([f"- [ ] {task}" for task in tasks])
```

---

## 📊 Telegram MCP Commands Reference

### Core Messaging Commands

| Command | Description | Parameters | Return Type |
|---------|-------------|------------|-------------|
| `send_message` | Отправить сообщение в чат | `chat_id: int, message: str` | `str` |
| `edit_message` | Редактировать отправленное сообщение | `chat_id: int, message_id: int, new_text: str` | `str` |
| `delete_message` | Удалить сообщение | `chat_id: int, message_id: int` | `str` |
| `forward_message` | Переслать сообщение | `from_chat_id: int, message_id: int, to_chat_id: int` | `str` |
| `reply_to_message` | Ответить на сообщение | `chat_id: int, message_id: int, text: str` | `str` |

### Chat Management Commands

| Command | Description | Parameters | Return Type |
|---------|-------------|------------|-------------|
| `get_chats` | Получить список чатов | `page: int, page_size: int` | `str` |
| `get_chat` | Получить информацию о чате | `chat_id: int` | `str` |
| `create_group` | Создать группу | `title: str, user_ids: list` | `str` |
| `create_channel` | Создать канал | `title: str, about: str, megagroup: bool` | `str` |
| `edit_chat_title` | Изменить название чата | `chat_id: int, title: str` | `str` |

### Message Management Commands

| Command | Description | Parameters | Return Type |
|---------|-------------|------------|-------------|
| `get_messages` | Получить сообщения из чата | `chat_id: int, page: int, page_size: int` | `str` |
| `list_messages` | Список сообщений с фильтрами | `chat_id: int, limit: int, search_query: str, from_date: str, to_date: str` | `str` |
| `search_messages` | Поиск сообщений в чате | `chat_id: int, query: str, limit: int` | `str` |
| `get_message_context` | Получить контекст сообщения | `chat_id: int, message_id: int, context_size: int` | `str` |

### Pin and Archive Commands

| Command | Description | Parameters | Return Type |
|---------|-------------|------------|-------------|
| `pin_message` | Закрепить сообщение | `chat_id: int, message_id: int` | `str` |
| `unpin_message` | Открепить сообщение | `chat_id: int, message_id: int` | `str` |
| `get_pinned_messages` | Получить закрепленные сообщения | `chat_id: int` | `str` |
| `archive_chat` | Архивировать чат | `chat_id: int` | `str` |
| `unarchive_chat` | Разархивировать чат | `chat_id: int` | `str` |

### Contact Management Commands

| Command | Description | Parameters | Return Type |
|---------|-------------|------------|-------------|
| `list_contacts` | Список контактов | - | `str` |
| `search_contacts` | Поиск контактов | `query: str` | `str` |
| `add_contact` | Добавить контакт | `phone: str, first_name: str, last_name: str` | `str` |
| `delete_contact` | Удалить контакт | `user_id: int` | `str` |
| `get_contact_ids` | Получить ID контактов | - | `str` |

---

## 🚀 Telegram Checklist Workflow

### 1. Подготовка к отправке checklist

```python
# STEP 1: Валидация учетных данных Telegram
async def validate_telegram_credentials() -> bool:
    """Проверка доступности Telegram MCP сервера"""
    try:
        result = await mcp_telegram_mcp_get_me()
        return "success" in result.lower()
    except Exception as e:
        logger.error(f"Telegram credentials validation failed: {e}")
        return False

# STEP 2: Поиск или создание чата
async def find_or_create_chat(chat_identifier: str) -> int:
    """Найти существующий чат или создать новый"""
    try:
        # Попытка найти чат по ID или имени
        if chat_identifier.isdigit():
            chat_id = int(chat_identifier)
            result = await mcp_telegram_mcp_get_chat(chat_id)
            if "error" not in result.lower():
                return chat_id
        else:
            # Поиск по имени контакта
            result = await mcp_telegram_mcp_get_direct_chat_by_contact(chat_identifier)
            if "error" not in result.lower():
                # Извлечь chat_id из результата
                return extract_chat_id_from_result(result)
        
        # Если чат не найден, создать новый
        return await create_new_chat(chat_identifier)
    except Exception as e:
        logger.error(f"Chat creation/finding failed: {e}")
        raise
```

### 2. Отправка checklist

```python
# STEP 3: Форматирование и отправка checklist
async def send_checklist(chat_id: int, checklist_data: dict) -> dict:
    """Отправить checklist в Telegram"""
    try:
        # Форматирование checklist в markdown
        formatted_message = format_checklist_markdown(checklist_data)
        
        # Отправка сообщения
        result = await mcp_telegram_mcp_send_message(chat_id, formatted_message)
        
        if "success" in result.lower():
            # Получение ID отправленного сообщения
            message_id = await get_last_message_id(chat_id)
            
            return {
                "success": True,
                "chat_id": chat_id,
                "message_id": message_id,
                "formatted_message": formatted_message
            }
        else:
            return {"success": False, "error": result}
            
    except Exception as e:
        logger.error(f"Checklist sending failed: {e}")
        return {"success": False, "error": str(e)}

# STEP 4: Закрепление checklist (опционально)
async def pin_checklist(chat_id: int, message_id: int) -> bool:
    """Закрепить checklist в чате"""
    try:
        result = await mcp_telegram_mcp_pin_message(chat_id, message_id)
        return "success" in result.lower()
    except Exception as e:
        logger.error(f"Checklist pinning failed: {e}")
        return False
```

### 3. Обновление checklist

```python
# STEP 5: Обновление пункта checklist
async def update_checklist_item(chat_id: int, message_id: int, 
                               item_index: int, new_status: str, 
                               original_checklist: dict) -> bool:
    """Обновить статус пункта в checklist"""
    try:
        # Обновление данных checklist
        updated_checklist = original_checklist.copy()
        if 0 <= item_index < len(updated_checklist["items"]):
            updated_checklist["items"][item_index]["status"] = new_status
            updated_checklist["last_updated"] = datetime.now().isoformat()
        
        # Форматирование обновленного сообщения
        updated_message = format_checklist_markdown(updated_checklist)
        
        # Редактирование сообщения
        result = await mcp_telegram_mcp_edit_message(chat_id, message_id, updated_message)
        
        return "success" in result.lower()
        
    except Exception as e:
        logger.error(f"Checklist update failed: {e}")
        return False

# STEP 6: Валидация обновления
async def validate_checklist_update(chat_id: int, message_id: int) -> bool:
    """Проверить успешность обновления checklist"""
    try:
        # Получение контекста сообщения
        result = await mcp_telegram_mcp_get_message_context(chat_id, message_id, 1)
        
        # Проверка наличия обновленного контента
        return "last_updated" in result and "success" not in result.lower()
        
    except Exception as e:
        logger.error(f"Checklist validation failed: {e}")
        return False
```

### 4. Форматирование checklist

```python
def format_checklist_markdown(checklist_data: dict) -> str:
    """Форматировать checklist в markdown для Telegram"""
    title = checklist_data.get("title", "Checklist")
    items = checklist_data.get("items", [])
    last_updated = checklist_data.get("last_updated", "")
    
    # Заголовок
    message = f"📋 **{title}**\n\n"
    
    # Пункты checklist
    for i, item in enumerate(items, 1):
        status = item.get("status", "pending")
        text = item.get("text", "")
        
        if status == "completed":
            checkbox = "✅"
        elif status == "in_progress":
            checkbox = "🔄"
        else:
            checkbox = "⏳"
        
        message += f"{checkbox} **{i}.** {text}\n"
    
    # Информация об обновлении
    if last_updated:
        message += f"\n_Обновлено: {last_updated}_"
    
    return message

def extract_chat_id_from_result(result: str) -> int:
    """Извлечь chat_id из результата MCP команды"""
    import re
    match = re.search(r'ID:\s*(\d+)', result)
    if match:
        return int(match.group(1))
    raise ValueError("Could not extract chat_id from result")
```

---

## 🔐 Security and Credentials Management

### Profile Management

Telegram MCP поддерживает множественные профили через переменную окружения `TELEGRAM_USER`:

#### **LISA PROFILE:**
```bash
# Keychain keys
lisa_tg_api_key (service: lisa_tg_api_key, account: lisa)
lisa_tg_app_hash (service: lisa_tg_app_hash, account: lisa)  
lisa_tg_session (service: lisa_tg_session, account: lisa)
lisa_tg_phone (service: lisa_tg_phone, account: lisa)
```

#### **IK PROFILE (ikrasinsky):**
```bash
# New format keys
ik_tg_api_id (service: ik_tg_api_id, account: ilyakrasinsky)
ik_tg_api_hash (service: ik_tg_api_hash, account: ilyakrasinsky)
ik_tg_session (service: ik_tg_session, account: ilyakrasinsky)
ik_tg_phone (service: ik_tg_phone, account: ilyakrasinsky)

# Legacy format keys (for backward compatibility)
telegram_api_id (service: telegram_api_id, account: ilyakrasinsky)
telegram_api_hash (service: telegram_api_hash, account: ilyakrasinsky)
telegram_session (service: telegram_session, account: ilyakrasinsky)
```

### Configuration in Cursor

```json
{
  "mcpServers": {
    "telegram-mcp": {
      "command": "/path/to/.venv/bin/python",
      "args": ["/path/to/heroes_platform/shared/credentials_wrapper.py", "telegram", "/path/to/.venv/bin/python", "/path/to/heroes_platform/telegram-mcp/main.py"],
      "env": {
        "PYTHONPATH": "/path/to/heroes_platform",
        "TELEGRAM_USER": "ikrasinsky"
      }
    }
  }
}
```

### Profile Switching

```bash
# Switch to LISA profile
sed -i 's/"TELEGRAM_USER": "ikrasinsky"/"TELEGRAM_USER": "lisa"/' .cursor/mcp.json

# Switch to IK profile  
sed -i 's/"TELEGRAM_USER": "lisa"/"TELEGRAM_USER": "ikrasinsky"/' .cursor/mcp.json

# Check current profile
grep "TELEGRAM_USER" .cursor/mcp.json
```

---

## 🐛 Troubleshooting and Debugging

### Common Issues

#### 1. "No tools or prompts" в Cursor
**Симптомы:**
- Cursor показывает "No tools or prompts" для telegram-mcp
- MCP сервер не загружается
- Ошибки при запуске telegram-mcp

**Root Cause Analysis:**
1. **Why #1**: Почему Cursor не видит Telegram MCP инструменты?
   → Cursor не может подключиться к telegram-mcp серверу

2. **Why #2**: Почему Cursor не может подключиться к серверу?
   → Переменная `${workspaceFolder}` не разрешается правильно в конфигурации MCP

3. **Why #3**: Почему переменная `${workspaceFolder}` не разрешается?
   → Cursor не поддерживает переменные `${workspaceFolder}` в mcp.json

4. **Why #4**: Почему Cursor не поддерживает эту переменную?
   → Это ограничение текущей версии Cursor

5. **Why #5**: Почему есть это ограничение?
   → **КОРНЕВАЯ ПРИЧИНА**: Cursor требует абсолютные пути для MCP серверов

**Решение:**
1. Замените все `${workspaceFolder}` на абсолютные пути
2. Используйте системные переменные окружения `${HOME}`, `${PATH}`
3. Проверьте, что все пути существуют и корректны

#### 2. Ключи не найдены
**Симптомы:**
- "No credentials found" в логах
- Ошибки аутентификации Telegram

**Решение:**
1. Проверьте правильность названий ключей в keychain
2. Убедитесь, что account name соответствует профилю
3. Используйте `telegram_profile_manager.py` для диагностики

#### 3. "Cannot send requests while disconnected"
**Симптомы:**
- Ошибки при отправке сообщений
- Клиент не инициализирован

**Решение:**
1. Проверьте инициализацию Telegram клиента
2. Убедитесь, что сессия активна
3. Перезапустите MCP сервер

### Debugging Commands

```bash
# Check profile detection
grep "🔑 Using TELEGRAM_USER" logs/mcp_errors.log

# Check keychain keys
security dump-keychain | grep -i telegram

# Test profile manually
TELEGRAM_USER=lisa python main.py --help
TELEGRAM_USER=ikrasinsky python main.py --help

# Test credentials
python main.py --test-credentials

# List available tools
python main.py --list-tools
```

---

## 📈 Monitoring and Quality Assurance

### Key Metrics

1. **Message Delivery Rate**: % успешно отправленных сообщений
2. **Update Success Rate**: % успешно обновленных checklist'ов
3. **Response Time**: Среднее время ответа Telegram API
4. **Error Rate**: % ошибок при работе с Telegram
5. **Profile Switch Time**: Время переключения между профилями

### Quality Checklist

**Before executing ANY Telegram MCP command:**
- [ ] Telegram Standard v1.0 read and understood
- [ ] Profile configuration validated
- [ ] Credentials available in keychain
- [ ] Chat ID or contact identified
- [ ] Message content formatted correctly
- [ ] Error handling implemented
- [ ] Logging configured

**After executing ANY Telegram MCP command:**
- [ ] Response validated for success/error
- [ ] Message ID tracked (if applicable)
- [ ] Activity logged
- [ ] Error handling triggered (if needed)
- [ ] User notified of result
- [ ] State updated appropriately

### Continuous Improvement

- **Monitor error patterns** - Анализ повторяющихся ошибок
- **Track performance metrics** - Отслеживание производительности
- **Update documentation** - Регулярное обновление документации
- **Test new features** - Тестирование новых возможностей Telegram API
- **Optimize workflows** - Оптимизация процессов интеграции

---

## 📚 References and Resources

### Documentation
- [Telegram MCP Server README](heroes_platform/telegram-mcp/README.md)
- [Telegram MCP Usage Guide](heroes_platform/telegram-mcp/USAGE.md)
- [Profile Management Guide](heroes_platform/telegram-mcp/PROFILE_MANAGEMENT.md)
- [Registry Standard](abstract://standard:registry_standard)
- [Task Master Standard](abstract://standard:task_master_standard)

### External Resources
- [Telethon Documentation](https://docs.telethon.dev/)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [Cursor IDE Documentation](https://cursor.sh/docs)

### Source Code
- [Telegram MCP Main Server](heroes_platform/telegram-mcp/main.py)
- [Profile Manager](heroes_platform/telegram-mcp/telegram_profile_manager.py)
- [Keychain Integration](heroes_platform/telegram-mcp/keychain_integration.py)
- [Chat Exporter](heroes_platform/telegram-mcp/chat_exporter.py)

---

**Лицензия**: © 2025 Ilya Krasinsky. Все права защищены.
Стандарт разработан для внутреннего использования в рамках проекта heroes-platform.
Использование, распространение и модификация возможны только с письменного разрешения правообладателя.
Мониторинг соблюдения лицензии осуществляется Magic Rick Inc в интересах правообладателя с применением всех доступных правовых средств защиты.

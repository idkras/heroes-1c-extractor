{
  "name": "–ß—Ç–µ–Ω–∏–µ —á–∞—Ç–æ–≤ Slack –∏ Telegram –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞",
  "nodes": [
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "message",
        "operation": "getAll",
        "channelId": "={{ $env.SLACK_CHANNEL_ID }}",
        "returnAll": false,
        "limit": 50
      },
      "name": "Slack",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "credentials": {
        "slackOAuth2Api": {
          "id": "1",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getUpdates",
        "offset": 0,
        "limit": 50,
        "timeout": 0,
        "additionalFields": {
          "allowedUpdates": [
            "message"
          ]
        }
      },
      "name": "Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        240,
        480
      ],
      "credentials": {
        "telegramApi": {
          "id": "2",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è Slack –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\nlet messages = [];\n\n// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Slack\nif ($input.item(0).json.messages && Array.isArray($input.item(0).json.messages)) {\n  const slackMessages = $input.item(0).json.messages;\n  \n  slackMessages.forEach(msg => {\n    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Slack –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n    messages.push({\n      source: 'slack',\n      channel: $input.item(0).json.channel || 'unknown',\n      user: msg.user,\n      text: msg.text,\n      timestamp: new Date(Number(msg.ts) * 1000).toISOString(),\n      raw: msg\n    });\n  });\n}\n\n// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram\nif ($input.item(1).json.result && Array.isArray($input.item(1).json.result)) {\n  const telegramUpdates = $input.item(1).json.result;\n  \n  telegramUpdates.forEach(update => {\n    if (update.message) {\n      const msg = update.message;\n      \n      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n      messages.push({\n        source: 'telegram',\n        channel: msg.chat.id.toString(),\n        user: msg.from.username || msg.from.first_name || msg.from.id.toString(),\n        text: msg.text || '',\n        timestamp: new Date(msg.date * 1000).toISOString(),\n        raw: msg\n      });\n    }\n  });\n}\n\n// –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ–±—Ä–∞—Ç–Ω–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è)\nmessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n\nreturn { messages };"
      },
      "name": "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        460,
        380
      ]
    },
    {
      "parameters": {
        "functionCode": "// –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º\n// –ü—Ä–∏–º–µ—Ä: #rick.ai –∏–ª–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ rick.ai –∏ —Ç.–¥.\n\nconst messages = $input.item(0).json.messages;\nconst projects = {};\n\nfor (const msg of messages) {\n  // –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ —Ä–∞–∑–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º\n  const hashtagRegex = /#([a-zA-Z0-9._-]+)/g;\n  const projectKeywordRegex = /–¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞\\s+([a-zA-Z0-9._-]+)/gi;\n  const domainRegex = /([a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\\.[a-zA-Z]{2,})/g;\n  \n  let matches = [];\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è\n  let match;\n  while (match = hashtagRegex.exec(msg.text)) {\n    matches.push(match[1]);\n  }\n  \n  while (match = projectKeywordRegex.exec(msg.text)) {\n    matches.push(match[1]);\n  }\n  \n  while (match = domainRegex.exec(msg.text)) {\n    matches.push(match[1]);\n  }\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –æ–±—ä–µ–∫—Ç—ã –ø—Ä–æ–µ–∫—Ç–æ–≤\n  for (const projectId of matches) {\n    if (!projects[projectId]) {\n      projects[projectId] = {\n        id: projectId,\n        messages: []\n      };\n    }\n    \n    projects[projectId].messages.push(msg);\n  }\n}\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏\nconst projectsArray = Object.values(projects);\n\nreturn { projectsArray };"
      },
      "name": "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        700,
        380
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "name": "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [
        920,
        380
      ]
    },
    {
      "parameters": {
        "functionCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ context.md —Ñ–æ—Ä–º–∞—Ç –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É v2.2\n\nconst project = $input.item(0).json;\nconst dateNow = new Date().toISOString().split('T')[0];\nconst timeNow = new Date().toTimeString().split(' ')[0];\nconst formattedDate = `${dateNow.replace(/-/g, ' ')} ${timeNow} CET`;\n\n// –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –¥–Ω—è–º\nconst messagesByDay = {};\nfor (const msg of project.messages) {\n  const day = msg.timestamp.split('T')[0];\n  if (!messagesByDay[day]) {\n    messagesByDay[day] = [];\n  }\n  messagesByDay[day].push(msg);\n}\n\n// –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ\nconst sortedDays = Object.keys(messagesByDay).sort().reverse();\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è context.md\nlet contextContent = `## ${formattedDate} - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–æ–≤\\n\\n`;\n\n// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è\nfor (const day of sortedDays) {\n  const dayMessages = messagesByDay[day];\n  \n  // –ü–µ—Ä–µ–≤–æ–¥–∏–º YYYY-MM-DD –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç\n  const [year, month, dayNum] = day.split('-');\n  const months = [\n    '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',\n    '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'\n  ];\n  const formattedDay = `${parseInt(dayNum)} ${months[parseInt(month) - 1]} ${year}`;\n  \n  contextContent += `### ${formattedDay}\\n\\n`;\n  \n  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–Ω—è –≤ –æ–±—Ä–∞—Ç–Ω–æ–º —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ\n  dayMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n  \n  for (const msg of dayMessages) {\n    const time = new Date(msg.timestamp).toTimeString().split(' ')[0];\n    contextContent += `- **${time}** ${msg.user}: ${msg.text}\\n`;\n  }\n  \n  contextContent += '\\n';\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è API\nconst apiData = {\n  context: {\n    project: project.id,\n    namespace: \"chat_updates\",\n    version: \"2.2\",\n    data: {\n      content: contextContent,\n      metadata: {\n        source: \"n8n_workflow\",\n        timestamp: new Date().toISOString(),\n        message_count: project.messages.length\n      }\n    }\n  }\n};\n\nreturn apiData;"
      },
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ context.md",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1140,
        380
      ]
    },
    {
      "parameters": {
        "url": "=http://localhost:5003/api/v1/external/context/{{ $input.item(0).json.context.project }}",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.ADVISING_API_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "context",
              "value": "={{ $input.item(0).json.context }}"
            }
          ]
        },
        "options": {}
      },
      "name": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1360,
        380
      ]
    },
    {
      "parameters": {
        "functionCode": "// –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è next_actions.md\n\nconst project = $input.item(0).json.context.project;\nconst dateNow = new Date().toISOString().split('T')[0];\nconst formattedDate = dateNow.replace(/-/g, '.');\n\n// –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á\n// –ò—â–µ–º —à–∞–±–ª–æ–Ω—ã –≤–∏–¥–∞ \"–Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å X\", \"–∑–∞–¥–∞—á–∞: X\", \"to do: X\"\nconst messages = $input.item(0).json.context.data.content.split('\\n');\nconst taskPatterns = [\n  /–Ω—É–∂–Ω–æ (—Å–¥–µ–ª–∞—Ç—å|–≤—ã–ø–æ–ª–Ω–∏—Ç—å) ([^\\n.]+)/i,\n  /–∑–∞–¥–∞—á–∞:? ([^\\n.]+)/i,\n  /to ?do:? ([^\\n.]+)/i,\n  /–Ω–∞–¥–æ ([^\\n.]+)/i,\n  /–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ ([^\\n.]+)/i\n];\n\nlet tasks = [];\n\nfor (const line of messages) {\n  for (const pattern of taskPatterns) {\n    const match = line.match(pattern);\n    if (match) {\n      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á—É\n      const taskText = match[match.length - 1].trim();\n      \n      // –ò—â–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (@–∏–º—è)\n      const assigneeMatch = line.match(/@([a-zA-Z0-9._-]+)/i);\n      const assignee = assigneeMatch ? `@${assigneeMatch[1]}` : '@team';\n      \n      // –ò—â–µ–º –¥–µ–¥–ª–∞–π–Ω (–¥–æ –î–î.–ú–ú.–ì–ì–ì–ì)\n      const deadlineMatch = line.match(/–¥–æ (\\d{1,2}[.\\/-]\\d{1,2}([.\\/-]\\d{2,4})?)/i);\n      const deadline = deadlineMatch ? deadlineMatch[1] : `–¥–æ ${new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU')}`;\n      \n      tasks.push({\n        text: taskText,\n        assignee: assignee,\n        deadline: deadline,\n        source: line\n      });\n    }\n  }\n}\n\n// –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –æ–±—â—É—é –∑–∞–¥–∞—á—É –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø–µ—Ä–µ–ø–∏—Å–∫–∏\nif (tasks.length === 0) {\n  tasks.push({\n    text: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É –ø–æ –ø—Ä–æ–µ–∫—Ç—É ${project}`,\n    assignee: '@team',\n    deadline: `–¥–æ ${new Date(new Date().getTime() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU')}`,\n    source: '–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ workflow'\n  });\n}\n\n// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ next_actions.md\nlet nextActionsContent = `## ${formattedDate}\\n\\n`;\nnextActionsContent += `### üè¢ ${project}\\n`;\n\nfor (const task of tasks) {\n  nextActionsContent += `- [ ] ${task.text} ‚Üí ${task.assignee} ‚Üí ${task.deadline}\\n`;\n}\n\nreturn { \n  project,\n  next_actions: nextActionsContent,\n  task_count: tasks.length\n};"
      },
      "name": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è next_actions",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1360,
        540
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:5003/api/v1/external/next_actions/update",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.ADVISING_API_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "project",
              "value": "={{ $input.item(0).json.project }}"
            },
            {
              "name": "content",
              "value": "={{ $input.item(0).json.next_actions }}"
            },
            {
              "name": "append",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "name": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ next_actions API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        1580,
        540
      ]
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 9,
              "minute": 0
            },
            {
              "hour": 13,
              "minute": 0
            },
            {
              "hour": 17,
              "minute": 0
            }
          ]
        }
      },
      "name": "–ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        40,
        380
      ]
    },
    {
      "parameters": {},
      "name": "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        440,
        540
      ]
    }
  ],
  "connections": {
    "Slack": {
      "main": [
        [
          {
            "node": "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram": {
      "main": [
        [
          {
            "node": "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º": {
      "main": [
        [
          {
            "node": "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ context.md",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ context.md": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ API",
            "type": "main",
            "index": 0
          },
          {
            "node": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è next_actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ API": {
      "main": [
        []
      ]
    },
    "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è next_actions": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ next_actions API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é": {
      "main": [
        [
          {
            "node": "Slack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "integration",
      "color": "#00CCFF"
    },
    {
      "name": "communication",
      "color": "#91BA5D"
    },
    {
      "name": "context",
      "color": "#FF9900"
    }
  ],
  "pinData": {},
  "versionId": "b34f34f1-c0e9-4b2f-952d-c3f3a2ed1cf8",
  "triggerCount": 1,
  "staticData": null,
  "createdAt": "2025-05-16T08:00:00.000Z",
  "updatedAt": "2025-05-16T08:30:00.000Z"
}
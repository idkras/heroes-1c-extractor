# Документация внешнего API Advising Platform

Версия: 1.0  
Дата: 15 мая 2025  
Автор: AI Assistant

## Обзор

Внешнее API Advising Platform предоставляет интерфейс для интеграции с внешними системами, такими как Slack и Telegram. Это API позволяет:

1. Обновлять контекст проектов из внешних источников
2. Создавать и обновлять задачи
3. Создавать и обновлять инциденты
4. Получать информацию о проектах
5. Выполнять поиск по документам

API построено на принципах REST, использует JSON для обмена данными и требует аутентификации для всех запросов.

## Базовый URL

```
https://advising-platform.heroes.camp/api/v1/external/{source}/action
```

где `{source}` - источник запроса (`slack` или `telegram`).

## Аутентификация и безопасность

Для доступа к API необходимо использовать токен доступа и специфичные для каждого источника механизмы верификации:

### Общие для всех источников

- Токен доступа в заголовке `Authorization: Bearer YOUR_API_TOKEN`
- Источники имеют разные токены (настраиваются в переменных окружения)

### Slack-специфичные механизмы

- Временная метка запроса в заголовке `X-Slack-Request-Timestamp`
- Подпись запроса в заголовке `X-Slack-Signature`
- Подпись формируется с использованием `SLACK_SIGNING_SECRET`

### Telegram-специфичные механизмы

- Подпись запроса в заголовке `X-Telegram-Bot-Api-Secret-Token`
- Подпись формируется с использованием `TELEGRAM_BOT_TOKEN`

## Формат запросов

Все запросы к API должны быть HTTP POST запросами с телом в формате JSON.

Общий формат запроса:

```json
{
  "action": "название_действия",
  "параметр1": "значение1",
  "параметр2": "значение2"
}
```

где `action` - обязательный параметр, указывающий на тип действия.

## Список доступных действий

### 1. update_context

Обновляет контекст проекта.

**Параметры:**

```json
{
  "action": "update_context",
  "context": {
    "project": "идентификатор_проекта",
    "namespace": "пространство_имен",
    "version": "версия_формата",
    "data": {
      // Данные контекста, зависят от namespace
    }
  }
}
```

**Пример ответа:**

```json
{
  "success": true,
  "message": "Контекст успешно обновлен для проекта heroes.camp",
  "timestamp": "2025-05-15T15:30:00Z"
}
```

### 2. create_task

Создает новую задачу.

**Параметры:**

```json
{
  "action": "create_task",
  "task": {
    "title": "Название задачи",
    "project": "идентификатор_проекта",
    "priority": "ПРИОРИТЕТ",
    "description": "Описание задачи",
    "due_date": "YYYY-MM-DD",
    "assignee": "@ответственный",
    "tags": ["тег1", "тег2"]
  }
}
```

**Пример ответа:**

```json
{
  "success": true,
  "message": "Задача создана с ID: task_id",
  "task": {
    "id": "task_id",
    "title": "Название задачи",
    "project": "идентификатор_проекта",
    "priority": "ПРИОРИТЕТ",
    "description": "Описание задачи",
    "due_date": "YYYY-MM-DD",
    "assignee": "@ответственный",
    "tags": ["тег1", "тег2"],
    "status": "new",
    "created_at": "2025-05-15T15:30:00Z",
    "updated_at": "2025-05-15T15:30:00Z"
  },
  "timestamp": "2025-05-15T15:30:00Z"
}
```

### 3. create_incident

Создает новый инцидент.

**Параметры:**

```json
{
  "action": "create_incident",
  "incident": {
    "title": "Название инцидента",
    "description": "Описание инцидента",
    "severity": "high",
    "category": "infrastructure",
    "project": "идентификатор_проекта",
    "assignee": "@ответственный",
    "tags": ["тег1", "тег2"]
  }
}
```

**Пример ответа:**

```json
{
  "success": true,
  "message": "Инцидент создан с ID: incident_id",
  "incident": {
    "id": "incident_id",
    "title": "Название инцидента",
    "description": "Описание инцидента",
    "severity": "high",
    "category": "infrastructure",
    "project": "идентификатор_проекта",
    "assignee": "@ответственный",
    "tags": ["тег1", "тег2"],
    "status": "new",
    "created_at": "2025-05-15T15:30:00Z",
    "updated_at": "2025-05-15T15:30:00Z"
  },
  "timestamp": "2025-05-15T15:30:00Z"
}
```

### 4. get_project_summary

Получает краткую информацию о проекте.

**Параметры:**

```json
{
  "action": "get_project_summary",
  "project_id": "идентификатор_проекта"
}
```

**Пример ответа:**

```json
{
  "success": true,
  "project": {
    "id": "heroes.camp",
    "name": "Heroes Camp",
    "description": "Описание проекта",
    "tasks": {
      "total": 25,
      "open": 10,
      "in_progress": 5,
      "completed": 10
    },
    "incidents": {
      "total": 5,
      "open": 2,
      "closed": 3
    },
    "last_updated": "2025-05-15T12:00:00Z"
  },
  "timestamp": "2025-05-15T15:30:00Z"
}
```

### 5. search

Выполняет поиск по документам.

**Параметры:**

```json
{
  "action": "search",
  "query": "поисковый запрос",
  "project": "идентификатор_проекта",
  "document_type": "task",
  "limit": 10
}
```

**Пример ответа:**

```json
{
  "success": true,
  "results": [
    {
      "id": "document_id_1",
      "type": "task",
      "title": "Название задачи 1",
      "snippet": "... содержание документа с выделенным совпадением ...",
      "relevance": 0.95,
      "url": "abstract://task:task_id_1"
    },
    {
      "id": "document_id_2",
      "type": "incident",
      "title": "Название инцидента",
      "snippet": "... содержание документа с выделенным совпадением ...",
      "relevance": 0.85,
      "url": "abstract://incident:incident_id_1"
    }
  ],
  "count": 2,
  "timestamp": "2025-05-15T15:30:00Z"
}
```

## Коды состояния HTTP

- `200 OK` - запрос успешно обработан
- `400 Bad Request` - ошибка в запросе (неверный формат, отсутствуют обязательные параметры)
- `401 Unauthorized` - ошибка аутентификации (неверный токен, устаревшая подпись)
- `404 Not Found` - запрашиваемый ресурс не найден
- `500 Internal Server Error` - внутренняя ошибка сервера

## Форматы данных

### Приоритеты задач

- `ALARM` - критическая ситуация, требует немедленного внимания
- `ASAP` (As Soon As Possible) - срочная задача
- `BLOCKER` - блокер, без решения невозможно двигаться дальше
- `RESEARCH` - исследование
- `SMALL TASK` - малая задача (до 2 часов)
- `EXCITER` - улучшение, не критичное для работы продукта

### Серьезность инцидентов

- `low` - низкая серьезность, некритичная проблема
- `medium` - средняя серьезность, влияет на работу, но есть обходные пути
- `high` - высокая серьезность, серьезно влияет на работу
- `critical` - критическая серьезность, полностью блокирует работу

### Категории инцидентов

- `process` - проблема в процессе
- `system` - системная проблема
- `communication` - проблема коммуникации
- `infrastructure` - проблема инфраструктуры
- `security` - проблема безопасности
- `other` - другое

## Примеры использования

См. файлы примеров в директории `advising_platform/src/api/examples/`.

## Ограничения

1. Максимальный размер запроса: 10 МБ
2. Частота запросов: не более 100 запросов в минуту
3. Время жизни подписи Slack: 5 минут
4. Максимальное количество результатов поиска: 100

## Обработка ошибок

В случае ошибки API возвращает JSON с информацией об ошибке:

```json
{
  "success": false,
  "error": "код_ошибки",
  "message": "Описание ошибки",
  "timestamp": "2025-05-15T15:30:00Z"
}
```

где `код_ошибки` может быть одним из следующих:
- `bad_request` - ошибка в запросе
- `unauthorized` - ошибка аутентификации
- `not_found` - ресурс не найден
- `internal_error` - внутренняя ошибка сервера

## Настройка и конфигурация

Для настройки внешнего API необходимо указать следующие переменные окружения:

```
ADVISING_API_SLACK_TOKEN=your-slack-api-token
ADVISING_API_TELEGRAM_TOKEN=your-telegram-api-token
SLACK_SIGNING_SECRET=your-slack-signing-secret
TELEGRAM_BOT_TOKEN=your-telegram-bot-token
```

См. файл `.env.example` для полного списка настроек.

## Безопасность

1. Используйте HTTPS для всех запросов к API
2. Регулярно обновляйте токены доступа
3. Храните секретные ключи в безопасном месте
4. Проверяйте подпись для всех запросов
5. Ограничивайте доступ к API только необходимыми IP-адресами

## Поддержка и контакты

При возникновении проблем или вопросов обращайтесь по адресу api-support@heroes.camp.

## Изменения и версионирование

Все изменения в API документируются в файле CHANGELOG.md. Текущая версия API: 1.0.
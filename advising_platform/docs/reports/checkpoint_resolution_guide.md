# Руководство по решению проблем с чекпоинтами

Это руководство содержит инструкции по диагностике и решению распространенных проблем с чекпоинтами в Advising Platform.

## Содержание

1. [Распространенные проблемы](#распространенные-проблемы)
2. [Пошаговое руководство по решению](#пошаговое-руководство-по-решению)
3. [Очистка кеша от несуществующих файлов](#очистка-кеша-от-несуществующих-файлов)
4. [Подготовка к созданию чекпоинта](#подготовка-к-созданию-чекпоинта)
5. [Восстановление системных файлов Replit](#восстановление-системных-файлов-replit)
6. [Полная диагностика](#полная-диагностика)

## Распространенные проблемы

Проблемы с чекпоинтами в Advising Platform обычно связаны с:

1. **Несоответствием размера кеша**: Разные компоненты системы используют разные значения max_cache_size
2. **Записями о несуществующих файлах в кеше**: Кеш содержит ссылки на файлы, которых больше нет
3. **Открытыми файловыми дескрипторами**: Некоторые процессы держат открытыми файлы, блокируя их изменение
4. **Отсутствием или повреждением системных файлов Replit**: Файлы .replit, .checksum_mapping и другие
5. **Неполным освобождением ресурсов**: Ресурсы не полностью освобождаются перед созданием чекпоинта

## Пошаговое руководство по решению

### Если при создании чекпоинта возникает ошибка "An unexpected error occurred"

1. Остановите все процессы и освободите ресурсы:
   ```bash
   python safe_checkpoint.py --cleanup
   ```

2. Очистите кеш от записей о несуществующих файлах:
   ```bash
   python clear_orphaned_cache_entries.py
   ```

3. Восстановите системные файлы Replit:
   ```bash
   python replit_checkpoint_repair.py
   ```

4. Подготовьте систему к созданию чекпоинта:
   ```bash
   python safe_checkpoint.py --prepare
   ```

5. Создайте чекпоинт через интерфейс Replit.

6. После восстановления из чекпоинта выполните:
   ```bash
   python safe_checkpoint.py --restore
   ```

## Очистка кеша от несуществующих файлов

Если ваш кеш содержит ссылки на файлы, которых больше нет, это может вызывать ошибки при создании чекпоинтов. Скрипт `clear_orphaned_cache_entries.py` анализирует кеш и удаляет все записи о несуществующих файлах:

```bash
python clear_orphaned_cache_entries.py
```

После очистки кеша он сохраняет обновленные данные в соответствующие файлы:

- `.cache_state.json`: Основное состояние кеша
- `.cache_detailed_state.pickle`: Детальное состояние кеша
- `.checkpoint_backup/cache_backup.pickle`: Резервная копия кеша
- `.checkpoint_backup/state_backup.json`: Резервная копия состояния

## Подготовка к созданию чекпоинта

Перед созданием чекпоинта необходимо правильно подготовить систему. Скрипт `safe_checkpoint.py --prepare` выполняет следующие действия:

1. Создает директорию для резервных копий
2. Сохраняет метаданные чекпоинта
3. Делает резервную копию кеша
4. Останавливает все файловые наблюдатели
5. Освобождает все ресурсы системы

```bash
python safe_checkpoint.py --prepare
```

## Восстановление системных файлов Replit

Если системные файлы Replit отсутствуют или повреждены, это может препятствовать созданию чекпоинтов. Скрипт `replit_checkpoint_repair.py` восстанавливает эти файлы:

```bash
python replit_checkpoint_repair.py
```

Этот скрипт:

1. Проверяет наличие файлов `.replit` и `.gitignore`
2. Восстанавливает отсутствующие файлы
3. Создает файл для принудительного обновления контрольных сумм
4. Выполняет индексацию файлов
5. Обновляет временные метки для инициации создания чекпоинта

## Полная диагностика

Для полной диагностики и решения всех проблем с чекпоинтами используйте скрипт `checkpoint_diagnostics.py`:

```bash
# Только диагностика
python checkpoint_diagnostics.py --diagnose

# Исправление выявленных проблем
python checkpoint_diagnostics.py --fix

# Запуск тестов
python checkpoint_diagnostics.py --test

# Комплексная диагностика, исправление и тестирование
python checkpoint_diagnostics.py --all
```

## Дополнительные рекомендации

1. Регулярно очищайте кеш от несуществующих файлов
2. Перед созданием чекпоинта всегда выполняйте `python safe_checkpoint.py --prepare`
3. После восстановления из чекпоинта выполняйте `python safe_checkpoint.py --restore`
4. При возникновении проблем запускайте полную диагностику
5. Следите за тем, чтобы max_cache_size был установлен на 500 (не меньше)

## Дополнительная информация

Более подробная информация о диагностике и устранении проблем доступна в файле [docs/checkpoint_diagnostics.md](docs/checkpoint_diagnostics.md).